function bindActions(){ViewState.Objects.userAttachments.assignButton.on("click",RoutineFunctions.AssignUser);ViewState.Objects.userAttachments.userList.on("click",".delete-button",RoutineFunctions.UnassignUserConfirm);ViewState.Objects.formButtons.addActivity.on("click",RoutineFunctions.AddActivity);ViewState.Objects.routineItems.listContainer.on("click",".delete-icon",RoutineFunctions.RemoveActivity);ViewState.Objects.routineItems.listContainer.on("click",".duplicate-icon",RoutineFunctions.DuplicateActivity);ViewState.Objects.formButtons.editButton.on("click",RoutineFunctions.EditRoutine);ViewState.Objects.formButtons.cancelButton.on("click",RoutineFunctions.CancelChanges);ViewState.Objects.routineForm.on("submit",RoutineFunctions.SaveRoutine)}var ViewState,RoutineFunctions,deleteLi;$(document).on("ready",function(){ViewState.Objects={alertModals:{smallModal:$("#smallAlertModal"),largeModal:$("#largeAddEditModal")},routineForm:$("#routine-form"),routineInputContainer:$("#routine-properties"),routineInputs:$("#routine-properties input, #routine-properties textarea, #routine-properties select"),userAttachments:{assignButton:$("#assign-user"),userSelector:$("#user-attachments .assign-selection select"),assignMessage:$("#user-assign-message"),userList:$("#user-attachments ul"),changeInProgress:!1},assignmentTemplate:$("#attachment-item-template"),routineItems:{listContainer:$("#routine-item-list"),activityEntries:function(){return $("#routine-item-list .routine-item")},contextActions:function(){return $("#routine-item-list .move-grabber, #routine-item-list .delete-icon, #routine-item-list .duplicate-icon")},inputs:function(){return $("#routine-item-list select, #routine-item-list input")}},activityTemplate:$("#routine-item-template"),formButtons:{addActivity:$("#add-routine-activity"),saveActions:$("#routine-form-actions .save-actions"),saveButton:$("#save-routine"),cancelButton:$("#cancel-changes"),loadingSpinner:$("#routine-form-actions .save-actions .loading"),editButton:$("#routine-form-actions .edit-button")}};bindActions();dragula([ViewState.Objects.routineItems.listContainer.get(0)],{moves:function(n,t,i){return i.classList.contains("move-grabber")}});newRoutine?ViewState.Set("NEW"):ViewState.Set("VIEW")});ViewState={CurrentState:"DEFAULT",CurrentActivityDOM:null};ViewState.RefreshState=function(){ViewState.Set(ViewState.CurrentState)};ViewState.Set=function(n){if(ViewState.CurrentState=n,n==="NEW"||n==="LOAD"||ViewState.Objects.userAttachments.changeInProgress)ViewState.Objects.userAttachments.userSelector.prop("disabled",!0),ViewState.Objects.userAttachments.assignButton.prop("disabled",!0),ViewState.Objects.userAttachments.userList.find(".delete-button").prop("disabled",!0),n==="NEW"?(ViewState.Objects.userAttachments.assignMessage.text("Routine must be created before assigning users"),ViewState.Objects.userAttachments.assignMessage.show()):ViewState.Objects.userAttachments.assignMessage.hide();else{var t=ViewState.Objects.userAttachments.userSelector.children("option").length===0;ViewState.Objects.userAttachments.userSelector.prop("disabled",t);ViewState.Objects.userAttachments.assignButton.prop("disabled",t);ViewState.Objects.userAttachments.userList.find(".delete-button").prop("disabled",!1);t?(ViewState.Objects.userAttachments.assignMessage.text("All users have been assigned to routine"),ViewState.Objects.userAttachments.assignMessage.show(),ViewState.Objects.userAttachments.userSelector.hide(),ViewState.Objects.userAttachments.assignButton.hide()):(ViewState.Objects.userAttachments.assignMessage.hide(),ViewState.Objects.userAttachments.userSelector.show(),ViewState.Objects.userAttachments.assignButton.show())}n==="NEW"||n=="EDIT"?(ViewState.Objects.routineInputs.prop("disabled",!1),ViewState.Objects.routineItems.contextActions().show(),ViewState.Objects.routineItems.inputs().prop("disabled",!1),ViewState.Objects.formButtons.saveButton.prop("disabled",!1),ViewState.Objects.formButtons.loadingSpinner.hide(),ViewState.Objects.formButtons.addActivity.prop("disabled",!1),ViewState.Objects.formButtons.addActivity.show(),ViewState.Objects.formButtons.saveActions.show(),ViewState.Objects.formButtons.editButton.hide(),n==="NEW"?(ViewState.Objects.formButtons.saveButton.text("Create Routine"),ViewState.Objects.formButtons.cancelButton.hide()):(ViewState.Objects.formButtons.saveButton.text("Save Changes"),ViewState.Objects.formButtons.cancelButton.prop("disabled",!1),ViewState.Objects.formButtons.cancelButton.show()),window.onbeforeunload=function(){return"Warning: you will lose all unsaved changes if you leave this page. Are you sure you wish to leave?"}):(n==="LOAD"||n==="VIEW")&&(ViewState.Objects.routineInputs.prop("disabled",!0),ViewState.Objects.routineItems.contextActions().hide(),ViewState.Objects.routineItems.inputs().prop("disabled",!0),n==="LOAD"?(ViewState.Objects.formButtons.addActivity.prop("disabled",!0),ViewState.Objects.formButtons.saveButton.prop("disabled",!0),ViewState.Objects.formButtons.cancelButton.prop("disabled",!0),ViewState.Objects.formButtons.loadingSpinner.show(),ViewState.Objects.formButtons.saveActions.show(),ViewState.Objects.formButtons.editButton.hide()):(ViewState.Objects.formButtons.addActivity.hide(),ViewState.Objects.formButtons.saveActions.hide(),ViewState.Objects.formButtons.editButton.show()),window.onbeforeunload=null)};RoutineFunctions={};RoutineFunctions.AssignUser=function(){if(ViewState.CurrentState==="VIEW"||ViewState.CurrentState==="EDIT"){var n=ViewState.Objects.userAttachments.userSelector.find("option:selected");ViewState.Objects.userAttachments.changeInProgress=!0;ViewState.RefreshState();$.ajax({method:"POST",url:"/Routine/CreateRoutineAttachment",data:{userId:n.attr("value"),routineId:ViewState.Objects.routineForm.find('[name="Id"]').val()}}).done(function(t){var i,r;t.success?(i=ViewState.Objects.assignmentTemplate.clone(!0),i.show(),i.attr("id",""),i.attr("attachment-id",""),r=i.html(),r=r.replace(/{id}/g,n.attr("value")),r=r.replace(/{name}/g,n.text()),i.html(r),i.attr("attachment-id",t.id),ViewState.Objects.userAttachments.userList.append(i),n.remove()):ShowModal(ViewState.Objects.alertModals.smallModal,"Error","An error occurred, please try again.")}).fail(function(){ShowModal(ViewState.Objects.alertModals.smallModal,"Error","An error occurred, please try again.")}).always(function(){ViewState.Objects.userAttachments.changeInProgress=!1;ViewState.RefreshState()})}else console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};RoutineFunctions.UnassignUserConfirm=function(){deleteLi=$(this).closest("li");ShowModal(ViewState.Objects.alertModals.largeModal,"Confirm","Are you sure you want to remove this user from the routine?","Yes",RoutineFunctions.UnassignUser)};RoutineFunctions.UnassignUser=function(n){ViewState.CurrentState==="VIEW"||ViewState.CurrentState==="EDIT"?(ShowLoader(n),deleteLi.find(".delete-button").prop("disabled",!0),$.ajax({method:"POST",url:"/Routine/DeleteRoutineAttachment",data:{id:deleteLi.attr("attachment-id")}}).done(function(n){if(n.success){var t=deleteLi.find(".user-detail");$("<option>",{value:t.attr("user-id"),text:t.text()}).appendTo(ViewState.Objects.userAttachments.userSelector);deleteLi.remove()}else deleteLi.find(".delete-button").prop("disabled",!1),ShowModal(ViewState.Objects.alertModals.smallModal,"Error","An error occurred, please try again.")}).fail(function(){deleteLi.find(".delete-button").prop("disabled",!1);ShowModal(ViewState.Objects.alertModals.smallModal,"Error","An error occurred, please try again.")}).always(function(){ViewState.Objects.alertModals.largeModal.modal("hide");ViewState.RefreshState()})):console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};RoutineFunctions.AddActivity=function(){if(ViewState.CurrentState==="NEW"||ViewState.CurrentState==="EDIT"){var n=ViewState.Objects.activityTemplate.clone(!1);n.attr("id","");ViewState.Objects.routineItems.listContainer.append(n);n.show()}else console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};$(document).on("focus",".datepicker_recurring_start",function(){$(this).datepicker({startDate:"+0d",format:"dd M yyyy"})});RoutineFunctions.RemoveActivity=function(){ViewState.CurrentState==="NEW"||ViewState.CurrentState==="EDIT"?$(this).parent().remove():console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};RoutineFunctions.DuplicateActivity=function(){if(ViewState.CurrentState==="NEW"||ViewState.CurrentState==="EDIT"){var n=$(this).parent().clone(!1);n.find('input[name$="Id]"]').val("");$(this).parent().after(n)}else console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};RoutineFunctions.EditRoutine=function(){ViewState.CurrentState==="VIEW"?(ViewState.Objects.routineInputs.filter(':not([type="radio"])').each(function(n,t){$(t).attr("reset-value",$(t).val())}),ViewState.DifficultyValue=ViewState.Objects.routineInputs.filter('[type="radio"]:checked').val(),ViewState.CurrentActivityDOM=ViewState.Objects.routineItems.listContainer.clone(!0),ViewState.Set("EDIT")):console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};RoutineFunctions.SaveRoutine=function(n){var t,i;n.preventDefault();t=0;ViewState.Objects.routineItems.activityEntries().each(function(){var n=t++;$(this).find("select, input").each(function(){$(this).attr("name",$(this).attr("name").replace("{index}",n))})});ViewState.Set("NEW");i=ViewState.Objects.routineForm.serializeObject();ViewState.Set("LOAD");$.ajax({method:"POST",url:"/Routine/CreateUpdate",data:{routine:i}}).done(function(n){for(var i="The following "+(n.errors.length>1?"error":"errors")+" occured:",t=0;t<n.errors.length;t++)i=i+"<br />"+n.errors[t];if(n.success){for(ViewState.Objects.routineForm.find('[name="Id"]').val(n.routineId),t=0;t<n.itemIds.length;t++)ViewState.Objects.routineForm.find('[name="RoutineItems['+t+'][Id]"]').val(n.itemIds[t]);newRoutine=!1;history.replaceState(null,"BioConnected | "+ViewState.Objects.routineForm.find('[name="Name"]').val(),"/Routine/Details/"+n.routineId);ShowModal(ViewState.Objects.alertModals.smallModal,"Success","Routine details have been saved."+(n.errors.length>0?"<br />"+i+"<br />It is recommended to refresh the page.":""));ViewState.Set("VIEW")}else ShowModal(ViewState.Objects.alertModals.smallModal,"Error",i),ViewState.Set(newRoutine?"NEW":"EDIT")}).fail(function(){ShowModal(ViewState.Objects.alertModals.smallModal,"Error","An error occurred, please try again.");ViewState.Set(newRoutine?"NEW":"EDIT")}).always(function(){ViewState.Objects.routineItems.activityEntries().find("select, input").each(function(){$(this).attr("name",$(this).attr("name").replace(/RoutineItems\[\d\]/g,"RoutineItems[{index}]"))})})};RoutineFunctions.CancelChanges=function(){ViewState.CurrentState==="EDIT"?(ViewState.Objects.routineInputs.filter(':not([type="radio"])').each(function(n,t){$(t).val($(t).attr("reset-value"))}),ViewState.Objects.routineInputs.filter('[type="radio"]').prop("checked",!1),ViewState.Objects.routineInputs.filter('[type="radio"][value="'+ViewState.DifficultyValue+'"]').prop("checked",!0),ViewState.Objects.routineItems.listContainer.empty().append(ViewState.CurrentActivityDOM.children()),ViewState.CurrentActivityDOM=null,ViewState.Set("VIEW")):console.error("ViewState desync! Current known state: "+ViewState.CurrentState)};flattenObject=function(n){function i(n,r){var u,e,o,f;if(Object(n)!==n)t[r]=n;else if(Array.isArray(n)){for(u=0,e=n.length;u<e;u++)i(n[u],r+"["+u+"]");e==0&&(t[r]=[])}else{o=!0;for(f in n)o=!1,i(n[f],r?r+"."+f:f);o&&r&&(t[r]={})}}var t={};return i(n,""),t};